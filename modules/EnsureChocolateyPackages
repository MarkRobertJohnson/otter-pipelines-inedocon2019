##AH:UseTextMode
module EnsureChocolateyPackages<%ChocolateyPackages>
{
    # Loop over Module list to install
    foreach $packageName in @MapKeys(%ChocolateyPackages)
    {
        set $packageVersion = %ChocolateyPackages[$packageName];

     
        Log-Information Ensuring Chocolatey package $packageName $packageVersion;
        set $startTime = $PSEval("Get-Date");
    
      PSDsc cChoco::cChocoPackageInstaller
      (
          Otter_ConfigurationKey: Name,
          Name: $PackageName,
          Version: $PackageVersion,
          Ensure: Present,
          AutoUpgrade: True,
          Source: $ChocolateyFeedUrl
      );
      
     # PSEnsure
     # (
     #     Key: Chocolatey package: $PackageName|$PackageVersion,
     #     Value: $PackageName|$PackageVersion,
     #     Collect: c:\ProgramData\Chocolatey\choco.exe list --limit-output --by-id-only -lo --version=$PackageVersion --exact "$PackageName",
     #     Configure: >>
     #         c:\ProgramData\Chocolatey\choco.exe install $Packagename --version=$PackageVersion -y -s $ChocolateyFeedUrl --no-progress 
     #         #if($LASTEXITCODE) {throw "Error installing $PackageName|$PackageVersion"}
     #         >>,
     #     UseExitCode: false
     # );
       
        Log-Information "Total time to install Chocolatey package $PackageName|$PackageVersion";
        call LogElapsedTime
        (
            FromDateTime: $startTime
        );
        
    }
}


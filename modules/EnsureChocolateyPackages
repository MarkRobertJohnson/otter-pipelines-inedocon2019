module EnsureChocolateyPackages<%ChocolateyPackages>
{
    set %ChocolateyPackages = %FromJson($ChocolateyPackagesBuildJson);

    # Loop over Module list to install
    foreach $packageName in @MapKeys(%ChocolateyPackages)
    {
        set $packageVersion = %ChocolateyPackages[$packageName];

        Log-Information Ensuring Chocolatey package $packageName $packageVersion;

        Execute-PowerShell Write-Host "Start installing Chocolatey package $PackageName at $(Get-Date)";

        PSDsc cChoco::cchocopackageinstaller
        (
            Otter_ConfigurationKey: Name,
            Name: $PackageName,
            Version: $PackageVersion,
            Ensure: Present,
            AutoUpgrade: True
        );

        Execute-PowerShell Write-Host "Completed installing Chocolatey package $PackageName at $(Get-Date)";
    }
}

##AH:UseTextMode
module BootStrapPowerShell
{
    set @bootStrapPsPackages = @(PSDscResources, PackageManagementProviderResource, PackageManagement);

    foreach $ModuleName in @bootStrapPsPackages
    {
        PSEnsure
        (
            Key: $ModuleName installed,
            Value: True,
            Collect: "!!(Get-DscResource -Module $ModuleName -ErrorAction SilentlyContinue)",
            Configure: Install-Module $ModuleName -Force  -AllowClobber -verbose -SkipPublisherCheck,
            CollectScriptParams: %(ModuleName: $ModuleName),
            ConfigureScriptParams: %(ModuleName: $ModuleName)
        );
    }
    
    PSEnsure
    (
        Key: PowerShell MaxEnvelopeSizekb,
        Value: $PowerShell_MaxEnvelopeSizekb,
        Collect: "(Get-Item WSMan:\localhost\MaxEnvelopeSizekb).Value",
        Configure: >>"
        `$nlm = [Activator]::CreateInstance([Type]::GetTypeFromCLSID([Guid]"{DCB00C01-570F-4A9B-8D69-199FDBA5723B}"))
        `$connections = `$nlm.getnetworkconnections()
        `$connections | foreach {
            if ((`$_.getnetwork().getcategory() -eq 0) -and (`$_.getnetwork().getcategory() -ne 2))
            {
                `$_.getnetwork().setcategory(1)
            }
        }
        Set-Item WSMan:\localhost\MaxEnvelopeSizekb -Value $PowerShell_MaxEnvelopeSizekb
        ">>
    );
}
